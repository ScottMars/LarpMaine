<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voting</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Подключение Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Наши скрипты -->
    <script src="js/supabase-config.js"></script>
    <script src="js/voting-api.js"></script>
</head>
<body class="voting-page-body">
    <div class="frame voting-page">
        <!-- Фоновые эффекты -->
        <div class="bg-effect bg-effect-red"></div>
        <div class="bg-effect bg-effect-green"></div>
        
        <!-- Навигация -->
        <nav class="navbar">
            <div class="navbar-items">
                <div class="nav-item"><a href="index.html">Rules</a></div>
                <div class="nav-item"><a href="index.html">Rewards</a></div>
                <div class="nav-item active"><a href="voting.html">Votings</a></div>
                <div class="nav-item"><a href="index.html">Whitepaper</a></div>
                <div class="nav-item"><a href="index.html">Roadmap</a></div>
                <div class="nav-item"><a href="index.html">Leaderboard</a></div>
                <div class="nav-icon">
                    <img src="public/images/DS.png" alt="DS" class="icon-img">
                </div>
                <div class="nav-icon">
                    <img src="img/twitter-x.svg" alt="Twitter X" class="icon-img">
                </div>
                <div class="nav-icon">
                    <img src="public/images/fi-11823292.svg" alt="Telegram" class="icon-img">
                </div>
            </div>
        </nav>
        
        <!-- Основной контент -->
        <div class="voting-content">
            <!-- Заголовок голосования -->
            <h1 class="voting-main-title">Will Greenland join the USA?</h1>
            
            <!-- Изображения -->
            <div class="voting-images">
                <div class="image-with-label">
                    <div class="card-placeholder left-card-placeholder">
                        <img src="public/images/image-6.png" alt="Left Penguin" class="card-image">
                    </div>
                    <div class="token-label">$FREEPENGU</div>
                </div>
                <div class="timer-container">
                    <div class="timer-wrapper">
                        <div class="timer-circle">
                            <img src="public/images/ellipse-1.svg" alt="Timer dots" class="timer-dots">
                            <div class="timer-progress"></div>
                            <div class="timer-dot-indicator"></div>
                            <div class="timer-content">
                                <span id="timer">00:19:28</span>
                                <div class="timer-info">The winning option will launch a new coin</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="image-with-label">
                    <div class="card-placeholder right-card-placeholder">
                        <img src="public/images/image-2.png" alt="Right Penguin" class="card-image">
                    </div>
                    <div class="token-label">$GREENSTATE</div>
                </div>
            </div>
            
            <!-- Кнопки голосования -->
            <div class="voting-buttons">
                <button class="vote-btn vote-no">NO</button>
                <button class="vote-btn vote-yes">YES</button>
            </div>
            
            <!-- Индикатор результатов -->
            <div class="voting-results">
                <div class="results-container">
                    <div class="vote-count no-votes">423</div>
                    <div class="progress-bar">
                        <div class="red-dots-line"></div>
                        <div class="vertical-separator"></div>
                        <div class="green-dots-line"></div>
                    </div>
                    <div class="vote-count yes-votes">963</div>
                </div>
            </div>
            
            <!-- Заголовок коллекции карточек -->
            <h2 class="cards-title">Collect this NFT cards during event</h2>
            
            <!-- Карточки NFT -->
            <div class="nft-cards-container">
                <div class="nft-row">
                    <img src="public/images/NFT4.png" alt="PICKLE JD VANCE" class="nft-card">
                    <img src="public/images/NFT3.png" alt="MEXICAN TRUMP" class="nft-card">
                    <img src="public/images/NFT1.png" alt="XIPOOH" class="nft-card">
                    <img src="public/images/NFT2.png" alt="J.D.VANCE" class="nft-card">
                    <img src="public/images/NFT5.png" alt="SPACE MUSK" class="nft-card">
                </div>
                <div class="nft-row">
                    <img src="public/images/NFT5.png" alt="SPACE MUSK" class="nft-card">
                    <img src="public/images/NFT3.png" alt="MEXICAN TRUMP" class="nft-card">
                    <img src="public/images/NFT4.png" alt="PICKLE JD VANCE" class="nft-card">
                    <img src="public/images/NFT1.png" alt="XIPOOH" class="nft-card">
                    <img src="public/images/NFT2.png" alt="J.D.VANCE" class="nft-card">
                </div>
            </div>
        </div>
        
        <!-- Градиентный оверлей для нижней части -->
        <div class="bottom-overlay"></div>
    </div>
    
    <script>
    // Инициализация страницы голосования
    document.addEventListener('DOMContentLoaded', async function() {
        // Элементы UI
        const timerElement = document.getElementById('timer');
        const timerProgress = document.querySelector('.timer-progress');
        const timerDotIndicator = document.querySelector('.timer-dot-indicator');
        const voteButtons = document.querySelectorAll('.vote-btn');
        const noVotesElement = document.querySelector('.no-votes');
        const yesVotesElement = document.querySelector('.yes-votes');
        const redDotsLine = document.querySelector('.red-dots-line');
        const greenDotsLine = document.querySelector('.green-dots-line');
        const verticalSeparator = document.querySelector('.vertical-separator');
        const votingTitleElement = document.querySelector('.voting-main-title');
        const leftImageElement = document.querySelector('.left-card-placeholder img');
        const rightImageElement = document.querySelector('.right-card-placeholder img');
        const leftTokenLabel = document.querySelector('.image-with-label:first-child .token-label');
        const rightTokenLabel = document.querySelector('.image-with-label:last-child .token-label');
        
        // Переменные для хранения данных текущего голосования
        let currentVoting = null;
        let totalSeconds = 0;
        let totalInitialSeconds = 0;
        let timerInterval = null;
        
        // Загрузка данных голосования
        async function loadVotingData() {
            try {
                // Получаем текущее голосование
                currentVoting = await votingAPI.getCurrentVoting();
                
                if (!currentVoting) {
                    console.error('Активное голосование не найдено');
                    return;
                }
                
                // Устанавливаем заголовок
                votingTitleElement.textContent = currentVoting.title;
                
                // Устанавливаем изображения и подписи
                leftImageElement.src = currentVoting.no_option_image_url;
                rightImageElement.src = currentVoting.yes_option_image_url;
                leftTokenLabel.textContent = currentVoting.no_option_label;
                rightTokenLabel.textContent = currentVoting.yes_option_label;
                
                // Настраиваем таймер
                setupTimer(currentVoting.end_time);
                
                // Загружаем текущее количество голосов
                await updateVoteCounts();
                
                // Настраиваем обработчики кнопок голосования
                setupVoteButtons();
            } catch (error) {
                console.error('Ошибка при загрузке данных голосования:', error);
            }
        }
        
        // Настройка таймера
        function setupTimer(endTimeStr) {
            const now = new Date();
            const endTime = new Date(endTimeStr);
            
            // Вычисляем оставшееся время в секундах
            totalSeconds = Math.max(0, Math.floor((endTime - now) / 1000));
            totalInitialSeconds = totalSeconds;
            
            // Обновляем таймер сразу
            updateTimerDisplay();
            
            // Запускаем таймер
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }
        
        // Обновление отображения таймера
        function updateTimerDisplay() {
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                timerElement.textContent = "00:00:00";
                
                // По истечении таймера перезагружаем данные
                setTimeout(loadVotingData, 3000);
                return;
            }
            
            // Расчет времени
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Форматирование времени
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.textContent = formattedTime;
            
            // Расчет прогресса (от 0 до 1)
            const progress = 1 - (totalSeconds / totalInitialSeconds);
            
            // Обновление заполнения и позиции точки
            const angle = progress * 360;
            
            // Вычисляем позицию точки (в радианах)
            const dotAngle = angle * Math.PI / 180;
            
            // Вычисляем координаты точки
            const x = Math.sin(dotAngle);
            const y = -Math.cos(dotAngle);
            
            // Устанавливаем точку на круге
            const dotX = 50 + 48 * x;
            const dotY = 50 + 48 * y;
            
            // Перемещаем точку
            timerDotIndicator.style.left = `${dotX}%`;
            timerDotIndicator.style.top = `${dotY}%`;
            timerDotIndicator.style.display = 'block';
            
            // Создаем clipping path для линии заполнения
            let clipPath;
            if (angle <= 90) {
                clipPath = `polygon(50% 50%, 50% 0%, ${50 + 50 * Math.sin(dotAngle)}% ${50 - 50 * Math.cos(dotAngle)}%)`;
            } else if (angle <= 180) {
                clipPath = `polygon(50% 50%, 50% 0%, 100% 0%, ${50 + 50 * Math.sin(dotAngle)}% ${50 - 50 * Math.cos(dotAngle)}%)`;
            } else if (angle <= 270) {
                clipPath = `polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, ${50 + 50 * Math.sin(dotAngle)}% ${50 - 50 * Math.cos(dotAngle)}%)`;
            } else {
                clipPath = `polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, ${50 + 50 * Math.sin(dotAngle)}% ${50 - 50 * Math.cos(dotAngle)}%)`;
            }
            
            // Применяем стили для прогресса
            timerProgress.style.clipPath = clipPath;
            
            // Уменьшаем оставшееся время
            totalSeconds--;
        }
        
        // Обновление счетчиков голосов
        async function updateVoteCounts() {
            if (!currentVoting) return;
            
            try {
                const counts = await votingAPI.getVoteCounts(currentVoting.voting_id);
                
                // Получаем количество голосов для каждой опции
                const noVotes = counts.no || 0;
                const yesVotes = counts.yes || 0;
                
                // Обновляем отображение
                noVotesElement.textContent = noVotes;
                yesVotesElement.textContent = yesVotes;
                
                // Обновляем прогресс-бар
                const totalVotes = noVotes + yesVotes;
                
                if (totalVotes > 0) {
                    const noVotesPercentage = (noVotes / totalVotes) * 100;
                    const yesVotesPercentage = (yesVotes / totalVotes) * 100;
                    
                    // Обновляем размеры линий
                    redDotsLine.style.width = `${noVotesPercentage}%`;
                    greenDotsLine.style.width = `${yesVotesPercentage}%`;
                    
                    // Обновляем положение разделителя
                    verticalSeparator.style.left = `${noVotesPercentage}%`;
                }
            } catch (error) {
                console.error('Ошибка при обновлении счетчиков голосов:', error);
            }
        }
        
        // Настройка кнопок голосования
        function setupVoteButtons() {
            voteButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    if (!currentVoting) return;
                    
                    try {
                        let voted = false;
                        
                        if (this.classList.contains('vote-no')) {
                            voted = await votingAPI.vote(currentVoting.voting_id, false);
                        } else if (this.classList.contains('vote-yes')) {
                            voted = await votingAPI.vote(currentVoting.voting_id, true);
                        }
                        
                        if (voted) {
                            // Анимация клика на кнопку
                            this.classList.add('clicked');
                            setTimeout(() => {
                                this.classList.remove('clicked');
                            }, 300);
                            
                            // Обновляем счетчики
                            await updateVoteCounts();
                        } else {
                            console.warn('Не удалось проголосовать (возможно, вы уже голосовали)');
                        }
                    } catch (error) {
                        console.error('Ошибка при голосовании:', error);
                    }
                });
            });
        }
        
        // Запускаем загрузку данных
        loadVotingData();
        
        // Периодическое обновление данных
        setInterval(updateVoteCounts, 10000);
    });
    </script>
    
    <script src="js/main.js"></script>
</body>
</html> 